<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Study Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg1: #ffe6f0;
  --bg2: #e6dbff;
  --card: #ffffff;
  --border: #e9d2ff;
  --accent: #b084ff;
  --accent-strong: #8a2be2;
  --accent-dark: #5a2b8a;
  --thead: #f3d9ff;
  --text: #3a2b33;
  --shadow: rgba(90,34,138,0.10);
}
body.dark {
  --bg1:#3a3047;  
  --bg2:#5a3e7a;   
  --card:#2e2e2e;  
  --border:#6e5291;
  --accent:#c9a4ff;
  --accent-strong:#d7b8ff;
  --accent-dark:#a67de8;
  --thead:#a67de8; 
  --text:#d8c6f7;
  --shadow: rgba(0,0,0,0.5);
}

*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
  background: linear-gradient(135deg,var(--bg1),var(--bg2));
  min-height:100vh; display:flex; justify-content:center; padding:24px; color:var(--text);
}
.app{
  width:min(960px,100%); background:var(--card); border-radius:20px; padding:24px;
  box-shadow:0 6px 20px var(--shadow); border:2px solid var(--border); position:relative;
}
h1{font-weight:800;color:var(--accent-strong);font-size:2rem;margin-bottom:12px}
.subtle{color:var(--accent-dark);margin-bottom:16px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:16px}
.input{display:flex;flex-direction:column;gap:6px;background:var(--card);border:2px solid var(--border);
  padding:10px 12px;border-radius:12px;min-width:180px;box-shadow:0 2px 8px var(--shadow)}
label{font-size:.85rem;color:var(--accent-dark)}
input[type="text"],input[type="number"],select{border:1px solid #ffd1e6;border-radius:10px;padding:8px 10px;outline:none}
input[type="number"]{width:110px}
.btn{border:none;border-radius:14px;padding:10px 16px;font-weight:700;cursor:pointer;background:var(--accent);color:#fff;
  box-shadow:0 4px 10px rgba(136,77,255,0.15);transition:.18s}
.btn:hover{filter:brightness(1.03)}
.btn.secondary{background:#f3e8ff;color:#5a3b4c}
.section{margin-top:18px;padding:14px;border:2px dashed var(--border);border-radius:16px;background:var(--card)}
.section h2{margin-bottom:8px;color:var(--accent-dark);font-size:1.1rem}
table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden;border:2px solid var(--border)}
th,td{padding:10px 12px;text-align:left;border-bottom:1px solid #ffe0ef;word-break:break-word}
th{background:var(--thead);color:#6a294a;font-weight:800}
td.icon{text-align:center;font-size:1.2rem}
td.delete-col{width:180px;text-align:right}
.current{font-size:1.15rem;font-weight:800;background:var(--card);border:2px solid var(--border);padding:12px 14px;border-radius:12px}
.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:var(--card);color:var(--text);
  border:2px solid var(--border);font-weight:600;box-shadow:0 2px 6px var(--shadow)}
.progress-bar-container{background:#f2e8ff;border-radius:8px;overflow:hidden;height:12px;margin-top:6px}
.progress-bar{height:100%;background:linear-gradient(90deg,#4b1f84,#7b4cff);width:0%;transition:width .2s}
.progress-bar.running{filter:brightness(1.12) saturate(1.05)}
.warn{color:var(--accent-dark);font-weight:800;font-size:1.4rem}
.alert{color:var(--accent);font-weight:700}

/* Focus large overlay */
#focusOverlay{position:fixed;inset:0;z-index:9999;display:none;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--bg1),var(--bg2))}
/* keep original focus-card but tune responsiveness and sizing */
.focus-card{background:var(--card);border:2px solid var(--border);padding:40px;border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,0.18);
  width:96vw;max-width:960px;height:80vh;display:flex;flex-direction:column;justify-content:center;align-items:center}
#focusOverlay h1{font-size:2.4rem;color:var(--accent-dark);margin-bottom:8px}
#focusOverlay h2{font-size:1.5rem;color:#5a3b4c;margin-bottom:12px}
#focusOverlay p{font-size:1.1rem;color:#5a3b4c;margin-bottom:20px;text-align:center}

/* BIG timer element shown in focus mode */
.focusTimer{
  font-weight:800;
  font-size: clamp(2.4rem, 8vw, 6rem); /* responsive large size */
  line-height:1;
  color:var(--accent-dark);
  margin: 10px 0 18px 0;
  transition: transform .12s, color .12s, text-shadow .12s;
  text-align:center;
  user-select:none;
}
.focusTimer.urgent{
  transform:scale(1.08);
  color:var(--accent-strong);
  text-shadow: 0 8px 30px rgba(138,43,226,0.12);
}

/* small/medium screen safety */
.current.timer-running{ font-size: clamp(1.35rem, 3vw, 2.6rem); text-align:center; }

/* combo (type-or-pick) */
.combo{position:relative}
.combo input{padding-right:40px} /* reserve space for toggle */
.combo .combo-toggle{position:absolute;right:6px;top:7px;padding:6px 8px;border-radius:8px;cursor:pointer;font-weight:700;background:transparent;border:none;color:var(--accent-dark)}
.combo-list{position:absolute;left:0;right:0;top:calc(100% + 8px);z-index:1100;list-style:none;margin:0;padding:6px;border-radius:8px;border:2px solid var(--border);
  background:var(--card);box-shadow:0 6px 18px rgba(0,0,0,0.08);max-height:220px;overflow:auto;display:none}
.combo-list li{padding:8px;border-radius:8px;cursor:pointer}
.combo-list li:hover{background:var(--thead)}

/* Order overlay */
#orderOverlay{position:fixed;inset:0;z-index:10000;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.25)}
.order-card{background:var(--card);border-radius:12px;padding:18px;border:2px solid var(--border);width:92%;max-width:640px;box-shadow:0 10px 30px rgba(0,0,0,0.12)}
.order-list{list-style:none;padding:8px;margin:12px 0;max-height:340px;overflow:auto}
.order-list li{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;border:1px solid #f3e6fb;margin-bottom:8px}
.order-controls button{margin-left:6px}

/* in-app confirm (reset) */
#confirmOverlay{position:fixed;inset:0;z-index:10001;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.25)}
.confirm-card{background:var(--card);border-radius:12px;padding:20px;border:2px solid var(--border);width:90%;max-width:480px;box-shadow:0 8px 24px rgba(0,0,0,0.12)}
/* more responsive rules */
@media (max-width:920px){
  .focus-card{padding:28px;height:86vh}
}
@media (max-width:720px){
  table{display:block;overflow:auto;width:100%}
  .input{min-width:100%}
  td.delete-col{width:auto;text-align:right}
}
@media (max-width:520px){
  .row{flex-direction:column}
  .focus-card{height:90vh;padding:20px}
  .focusTimer{font-size: clamp(2rem, 12vw, 5rem)}
}
</style>
</head>
<body>
<div class="app">
  <h1>‚è≥ Study Tracker</h1>
  <p class="subtle">Plan your subjects and track your study time with precision.</p>

  <div class="row">
    <!-- combo input (type OR pick). Arrow toggles the suggestion list; adjusted padding avoids overlap -->
    <div class="input" style="min-width:280px">
      <label for="subject">Subject</label>
      <div class="combo">
        <input id="subject" type="text" placeholder="e.g., Math" autocomplete="off">
        <button id="subjectToggle" class="combo-toggle">‚ñæ</button>
        <ul id="subjectList" class="combo-list"></ul>
      </div>
    </div>

    <div class="input">
      <label for="planned">Planned Minutes (today)</label>
      <input id="planned" type="number" min="1" step="1" placeholder="e.g., 45">
    </div>

    <div class="input">
      <label for="breakMin">Break Minutes</label>
      <input id="breakMin" type="number" min="1" step="1" value="5">
    </div>

    <!-- 1) changed text to "‚ûï Add" (keeps id addBtn so your JS still works) -->
    <button class="btn" id="addBtn">‚ûï Add</button>
    <button class="btn secondary" id="darkModeBtn"> Dark Mode</button>
    <div class="pill">üí° Keep this tab active for best timing accuracy.</div>
  </div>

  <div class="section">
    <h2>Plan for Today</h2>
    <table id="planTable">
      <thead><tr><th></th><th>Subject</th><th>Planned (min)</th><th>Studied (min)</th><th>Remaining (min)</th><th></th></tr></thead>
      <tbody id="planBody"></tbody>
    </table>
  </div>

  <div class="section">
    <h2>üìÖ Daily Progress</h2>
    <div id="dailySummary"></div>
    <div class="progress-bar-container"><div class="progress-bar" id="dailyBar"></div></div>
  </div>

  <div class="section">
    <h2>üìÜ Weekly Progress</h2>
    <div style="display:flex;gap:10px;align-items:center;margin-bottom:8px">
      <label for="weeklyGoal" style="margin-right:6px">Weekly Goal (hours)</label>
      <input id="weeklyGoal" type="number" min="1" value="25" style="width:110px">
      <button class="btn secondary" id="saveWeeklyBtn">Save Goal</button>
    </div>
    <div id="weeklySummary"></div>
    <div class="progress-bar-container"><div class="progress-bar" id="weeklyBar"></div></div>
  </div>

  <div class="section">
    <h2>Current Task</h2>

    <!-- Top line: Start-with + Arrange only (single neat line) -->
    <div class="row" style="margin-bottom:8px; align-items:center;">
      <label for="startSelect" style="align-self:center;color:var(--accent-dark);margin-right:8px">Start with:</label>
      <select id="startSelect" style="border:1px solid #ffd1e6;border-radius:10px;padding:6px 8px;min-width:240px">
        <option value="">(Use arranged order)</option>
      </select>
      <button id="arrangeBtn" class="btn secondary" style="margin-left:8px">Arrange Order</button>
    </div>

    <!-- Second line: real controls (skip, start, pause, end, refresh, focus) -->
    <div class="row controls" id="mainControls" style="margin-bottom:10px">
      <button id="skipBreakBtn" class="btn secondary" style="display:none">Skip Break</button>
      <button class="btn" id="startBtn">Start Session</button>
      <button class="btn secondary" id="pauseBtn">Pause</button>
      <button class="btn secondary" id="endBtn">End Session</button>
      <button class="btn secondary" id="resetBtn">Refresh Tracker</button>
      <button class="btn" id="focusBtn">Focus Mode</button>
    </div>

    <!-- Once ended: only these two appear -->
    <div class="row" id="endedControls" style="display:none; gap:10px; margin-bottom:10px;">
      <button id="saveSessionBtn" class="btn">Save Session</button>
      <button id="startNewBtn" class="btn secondary">Start New Session</button>
    </div>

    <div class="current" id="display">No task running.</div>
  </div>
</div>

<!-- Focus overlay -->
<div id="focusOverlay">
  <div class="focus-card">
    <h1 id="focusHeading">üìö Study Time</h1>
    <h2 id="focusSubject">Subject: -</h2>

    <!-- 2) Added explicit large timer element shown in Focus Mode -->
    <div id="focusTimer" class="focusTimer">00:00</div>

    <p id="focusMsg">Stay on task ‚Äî distractions are locked out!</p>
    <div class="row" style="justify-content:center;gap:12px">
      <button class="btn secondary" id="pauseFocus">Pause/Resume</button>
      <button class="btn secondary" id="exitFocus">Exit Focus Mode</button>
      <button class="btn secondary" id="skipBreakFocus" style="display:none">Skip Break</button>
    </div>
  </div>
</div>

<!-- Arrange order overlay -->
<div id="orderOverlay">
  <div class="order-card">
    <h2>Arrange Session Order</h2>
    <p style="margin-bottom:8px;color:var(--accent-dark)">Use the arrows to set your exact study sequence.</p>
    <ul id="orderList" class="order-list"></ul>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button id="orderReset" class="btn secondary">Reset to default</button>
      <button id="orderSave" class="btn">Save Order</button>
      <button id="orderCancel" class="btn secondary">Cancel</button>
    </div>
  </div>
</div>

<!-- In-app confirm for Refresh Tracker -->
<div id="confirmOverlay">
  <div class="confirm-card">
    <h3 style="margin-bottom:8px;color:var(--accent-dark)">Clear all data?</h3>
    <p style="margin-bottom:16px">This will remove subjects and the last 7 days of studied records. This action cannot be undone.</p>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button id="confirmCancel" class="btn secondary">Cancel</button>
      <button id="confirmOk" class="btn">Yes, clear</button>
    </div>
  </div>
</div>

<audio id="alertSound" src="https://www.soundjay.com/buttons/sounds/button-16.mp3" preload="auto"></audio>

<script>
// ----- data and refs -----
let subjects = JSON.parse(localStorage.getItem('subjects')) || [];
let weeklyGoalHours = parseInt(localStorage.getItem('weeklyGoalHours'),10) || 25;
let sessionOrder = JSON.parse(localStorage.getItem('sessionOrder') || 'null');

const planBody = document.getElementById('planBody');
const display = document.getElementById('display');
const focusOverlay = document.getElementById('focusOverlay');
const focusHeading = document.getElementById('focusHeading');
const focusSubject = document.getElementById('focusSubject');
const focusMsg = document.getElementById('focusMsg');
const focusTimer = document.getElementById('focusTimer'); // <- new big timer ref
const alertSound = document.getElementById('alertSound');
const dailySummary = document.getElementById('dailySummary');
const dailyBar = document.getElementById('dailyBar');
const weeklySummary = document.getElementById('weeklySummary');
const weeklyBar = document.getElementById('weeklyBar');
const weeklyGoalInput = document.getElementById('weeklyGoal');

const subjectInput = document.getElementById('subject');
const subjectToggle = document.getElementById('subjectToggle');
const subjectList = document.getElementById('subjectList');

const startSelect = document.getElementById('startSelect');
const arrangeBtn = document.getElementById('arrangeBtn');
const skipBreakBtn = document.getElementById('skipBreakBtn');
const skipBreakFocusBtn = document.getElementById('skipBreakFocus');

const mainControls = document.getElementById('mainControls');
const endedControls = document.getElementById('endedControls');
const saveSessionBtn = document.getElementById('saveSessionBtn');
const startNewBtn = document.getElementById('startNewBtn');

const orderOverlay = document.getElementById('orderOverlay');
const orderList = document.getElementById('orderList');
const orderSave = document.getElementById('orderSave');
const orderCancel = document.getElementById('orderCancel');
const orderReset = document.getElementById('orderReset');

const confirmOverlay = document.getElementById('confirmOverlay');
const confirmOk = document.getElementById('confirmOk');
const confirmCancel = document.getElementById('confirmCancel');

weeklyGoalInput.value = weeklyGoalHours;

let queue = [], idx = -1, timerId = null;
let startTime = 0, lastTick = 0, durationMs = 0, elapsedMs = 0, paused = false, baseStudiedAtStart = 0;
let breakDurationMs = 5 * 60000;
let isBreak = false, currentSubject = null;

// ----- utilities -----
function saveSubjects(){ localStorage.setItem('subjects', JSON.stringify(subjects)); }
function saveSessionOrder(){ localStorage.setItem('sessionOrder', JSON.stringify(sessionOrder)); }
function mins(ms){ return Math.floor(ms/60000); }
function hrs(ms){ return (ms/3600000).toFixed(1); }
function fmtClockFromSeconds(seconds){ if(seconds<0)seconds=0; return `${String(Math.floor(seconds/60)).padStart(2,'0')}:${String(seconds%60).padStart(2,'0')}`; }
function fmtClock(ms){ if(ms<0)ms=0; const t=Math.floor(ms/1000); return `${String(Math.floor(t/60)).padStart(2,'0')}:${String(t%60).padStart(2,'0')}`; }
function clamp(n,lo,hi){ return Math.max(lo,Math.min(hi,n)); }
function getDateKey(date){ return 'studied_' + date.toISOString().slice(0,10); }
function getTodayKey(){ return getDateKey(new Date()); }
function escapeHtml(str){ return String(str).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

// defaults
const defaultSubjects = ['Math','Physics','Chemistry','Biology','English','History','Computer Science','Economics','Art','Music','Philosophy','Psychology'];

// ----- session order helpers -----
function normalizeSessionOrder(){
  const n = subjects.length;
  if(!Array.isArray(sessionOrder)){
    sessionOrder = subjects.map((_,i)=>i);
    saveSessionOrder();
    return;
  }
  sessionOrder = sessionOrder.filter(i => Number.isInteger(i) && i >= 0 && i < n);
  for(let i=0;i<n;i++) if(!sessionOrder.includes(i)) sessionOrder.push(i);
  saveSessionOrder();
}

// ----- suggestion list (combo) -----
function refreshRegisteredSubjects(){
  const set = new Set(defaultSubjects.map(x=>x.trim()).filter(Boolean));
  subjects.forEach(s => { if(s.name && s.name.trim()) set.add(s.name.trim()); });
  subjectList.innerHTML = '';
  Array.from(set).forEach(name => {
    const li = document.createElement('li');
    li.textContent = name;
    li.addEventListener('click', ()=>{ subjectInput.value = name; subjectList.style.display='none'; });
    subjectList.appendChild(li);
  });
}
subjectToggle.addEventListener('click', (e)=>{ e.stopPropagation(); if(subjectList.style.display==='block') subjectList.style.display='none'; else subjectList.style.display='block'; });
subjectInput.addEventListener('input', ()=>{ // live filter
  const q = (subjectInput.value || '').toLowerCase();
  const items = Array.from(subjectList.children);
  let any=false;
  items.forEach(li=>{
    if(!q || li.textContent.toLowerCase().includes(q)){ li.style.display='block'; any=true; } else li.style.display='none';
  });
  subjectList.style.display = any ? 'block' : 'none';
});
document.addEventListener('click',(e)=>{ if(!document.querySelector('.combo')?.contains(e.target)) subjectList.style.display='none'; });

// ----- start select refresh -----
function refreshStartSelect(){
  startSelect.innerHTML = '';
  const def = document.createElement('option'); def.value = ''; def.textContent = '(Use arranged order)'; startSelect.appendChild(def);
  normalizeSessionOrder();
  sessionOrder.forEach((origIdx,pos)=>{
    const opt = document.createElement('option');
    opt.value = origIdx;
    const name = subjects[origIdx] ? subjects[origIdx].name : `#${origIdx}`;
    opt.textContent = `${pos+1}. ${name}`;
    startSelect.appendChild(opt);
  });
}

// ----- order overlay -----
function renderOrderList(){
  orderList.innerHTML = '';
  normalizeSessionOrder();
  sessionOrder.forEach((origIdx,pos)=>{
    const li = document.createElement('li');
    const left = document.createElement('div');
    left.textContent = (subjects[origIdx] ? subjects[origIdx].name : `#${origIdx}`);
    const controls = document.createElement('div');
    controls.className = 'order-controls';
    const up = document.createElement('button'); up.className='btn secondary'; up.textContent='‚Üë';
    const down = document.createElement('button'); down.className='btn secondary'; down.textContent='‚Üì';
    const trash = document.createElement('button'); trash.className='btn secondary'; trash.textContent='üóëÔ∏è';
    up.addEventListener('click', ()=>{ if(pos>0){ sessionOrder.splice(pos,1); sessionOrder.splice(pos-1,0,origIdx); renderOrderList(); }});
    down.addEventListener('click', ()=>{ if(pos < sessionOrder.length - 1){ sessionOrder.splice(pos,1); sessionOrder.splice(pos+1,0,origIdx); renderOrderList(); }});
    trash.addEventListener('click', ()=>{ sessionOrder.splice(pos,1); renderOrderList(); });
    controls.appendChild(up); controls.appendChild(down); controls.appendChild(trash);
    li.appendChild(left); li.appendChild(controls);
    orderList.appendChild(li);
  });
}
arrangeBtn.addEventListener('click', ()=>{ normalizeSessionOrder(); renderOrderList(); orderOverlay.style.display='flex'; });
orderCancel.addEventListener('click', ()=>{ orderOverlay.style.display='none'; refreshStartSelect(); });
orderSave.addEventListener('click', ()=>{ saveSessionOrder(); orderOverlay.style.display='none'; refreshStartSelect(); });
orderReset.addEventListener('click', ()=>{ sessionOrder = subjects.map((_,i)=>i); renderOrderList(); });

// ----- render table with inline edit (‚úÖ/‚ùå) -----
function renderPlan(){
  normalizeSessionOrder();
  planBody.innerHTML = '';
  subjects.forEach((s,i)=>{
    const tr = document.createElement('tr');
    let icon = 'üìö';
    const n = (s.name||'').toLowerCase();
    if(n.includes('math')) icon='üßÆ'; else if(n.includes('physics')) icon='üìê'; else if(n.includes('chem')) icon='‚öóÔ∏è';
    else if(n.includes('bio')) icon='üß¨'; else if(n.includes('english')) icon='üìù'; else if(n.includes('computer science')||n.includes('cs')) icon='üñ•Ô∏è';
    else if(n.includes('it')) icon='üíª'; else if(n.includes('account')) icon='üßæ'; else if(n.includes('econ')) icon='üìä';
    else if(n.includes('business')) icon='üíº'; else if(n.includes('law')) icon='‚öñÔ∏è'; else if(n.includes('psych')) icon='üß†';
    else if(n.includes('history')) icon='üìú'; else if(n.includes('geo')) icon='üåç'; else if(n.includes('art')) icon='üé®';
    else if(n.includes('music')) icon='üéµ'; else if(n.includes('philosophy')) icon='ü§î'; else if(n.includes('sociology')) icon='üßë‚Äçü§ù‚Äçüßë';
    const planned = mins(s.plannedMs||0);
    const studied = mins(s.studiedMs||0);
    const remaining = Math.max(0, planned - studied);
    const pct = s.plannedMs && s.plannedMs>0 ? Math.min(100, (s.studiedMs/s.plannedMs)*100) : 0;
    const pctStr = pct.toFixed(1) + '%';
    tr.innerHTML = `
      <td class="icon">${icon}</td>
      <td class="subject-cell">
        <span class="subjectName">${escapeHtml(s.name)}</span>
        <div class="progress-bar-container"><div class="progress-bar" data-idx="${i}" style="width:${pctStr}"></div></div>
      </td>
      <td class="planned">${planned}</td>
      <td>${studied}</td>
      <td>${remaining}</td>
      <td class="delete-col">
        <button class="btn secondary editBtn" style="display:none">‚úèÔ∏è</button>
        <button class="btn secondary deleteBtn" style="display:none">üóëÔ∏è</button>
      </td>
    `;
    planBody.appendChild(tr);

    tr.addEventListener('mouseenter', ()=>{
      const a = tr.querySelector('.deleteBtn'); const b = tr.querySelector('.editBtn');
      if(a) a.style.display='inline-block'; if(b) b.style.display='inline-block';
    });
    tr.addEventListener('mouseleave', ()=>{
      const a = tr.querySelector('.deleteBtn'); const b = tr.querySelector('.editBtn');
      if(a) a.style.display='none'; if(b) b.style.display='none';
    });

    // delete
    tr.querySelector('.deleteBtn').addEventListener('click', ()=>{
      subjects.splice(i,1); saveSubjects(); normalizeSessionOrder(); renderPlan(); updateSummaries(); refreshRegisteredSubjects(); refreshStartSelect();
    });

    // inline edit: (completed - Save / Cancel added)
    tr.querySelector('.editBtn').addEventListener('click', ()=>{
      const nameSpan = tr.querySelector('.subjectName');
      const plannedCell = tr.querySelector('.planned');
      const editBtn = tr.querySelector('.editBtn');
      const delBtn = tr.querySelector('.deleteBtn');
      const currentName = nameSpan.textContent;
      const currentPlanned = parseInt(plannedCell.textContent,10) || mins(s.plannedMs);

      if(editBtn) editBtn.style.display='none';
      if(delBtn) delBtn.style.display='none';

      nameSpan.innerHTML = `<input type="text" value="${escapeHtml(currentName)}" style="width:92%;box-sizing:border-box">`;
      plannedCell.innerHTML = `<input type="number" value="${currentPlanned}" min="1" style="width:80px">`;

      // create Save and Cancel buttons inside the delete-col for clear placement
      const saveBtn = document.createElement('button'); saveBtn.className='btn secondary saveBtn'; saveBtn.textContent='‚úÖ'; saveBtn.style.marginLeft='8px';
      const cancelBtn = document.createElement('button'); cancelBtn.className='btn secondary cancelBtn'; cancelBtn.textContent='‚ùå'; cancelBtn.style.marginLeft='8px';
      const actionCell = tr.querySelector('td.delete-col');
      // clear old contents (edit/delete hidden already) then append
      actionCell.innerHTML = '';
      actionCell.appendChild(saveBtn);
      actionCell.appendChild(cancelBtn);

      saveBtn.addEventListener('click', ()=>{
        const newName = (nameSpan.querySelector('input').value || currentName).trim();
        let newPlanned = parseInt(plannedCell.querySelector('input').value,10);
        if(!newPlanned || newPlanned <= 0) newPlanned = currentPlanned;
        s.name = newName;
        s.plannedMs = newPlanned * 60000;
        s.studiedMs = Math.min(s.studiedMs || 0, s.plannedMs);
        saveSubjects(); normalizeSessionOrder(); renderPlan(); updateSummaries(); refreshRegisteredSubjects(); refreshStartSelect();
      });

      cancelBtn.addEventListener('click', ()=>{
        // restore previous state without saving
        nameSpan.textContent = currentName;
        plannedCell.textContent = currentPlanned;
        // re-insert the edit/delete buttons so hover behavior remains consistent
        const restoreEdit = document.createElement('button'); restoreEdit.className='btn secondary editBtn'; restoreEdit.textContent='‚úèÔ∏è';
        const restoreDelete = document.createElement('button'); restoreDelete.className='btn secondary deleteBtn'; restoreDelete.textContent='üóëÔ∏è';
        actionCell.innerHTML = '';
        actionCell.appendChild(restoreEdit);
        actionCell.appendChild(restoreDelete);

        // reattach handlers for the restored buttons: (simple approach - re-renderPlan to rebind)
        renderPlan();
      });
    });

  });

  // running highlight
  document.querySelectorAll('.progress-bar').forEach(pb => pb.classList.remove('running'));
  if(currentSubject){
    const ii = subjects.indexOf(currentSubject);
    if(ii >= 0){
      const el = document.querySelector(`.progress-bar[data-idx='${ii}']`);
      if(el) el.classList.add('running');
    }
  }

  saveSubjects();
  refreshRegisteredSubjects();
  refreshStartSelect();
  renderOrderList();
}

// ----- queue & timer  -----
function buildQueue(){
  normalizeSessionOrder();
  queue = sessionOrder.map(origIdx => ({ kind:'study', subject: subjects[origIdx], origIndex: origIdx }));
}
function stopTimer(){ if(timerId){ clearInterval(timerId); timerId = null; } }

function startNext(){
  if(skipBreakBtn) skipBreakBtn.style.display='none';
  if(skipBreakFocusBtn) skipBreakFocusBtn.style.display='none';

  stopTimer();
  idx++;
  if(idx >= queue.length){ startBreak(); return; }
  const item = queue[idx];
  startTime = Date.now(); lastTick = startTime; elapsedMs = 0; paused = false;
  currentSubject = item.subject;
  const remaining = Math.max(0, (item.subject.plannedMs || 0) - (item.subject.studiedMs || 0));
  if(remaining === 0){ startNext(); return; }
  durationMs = remaining; baseStudiedAtStart = item.subject.studiedMs || 0;

  display.textContent = `Studying ${item.subject.name} ‚Äî ${fmtClock(durationMs)} remaining`;
  display.classList.add('timer-running'); // enlarge main display while active
  focusHeading.textContent = "üìö Study Time";
  focusSubject.textContent = `Subject: ${item.subject.name}`;
  focusMsg.textContent = "Stay on task ‚Äî distractions are locked out!";
  focusOverlay.style.display = 'flex';

  isBreak = false;
  renderPlan();
  timerId = setInterval(()=>tick(item),200);
}

function tick(item){
  if(paused) return;
  const now = Date.now();
  const delta = now - lastTick; lastTick = now; elapsedMs += delta;
  const remain = clamp(durationMs - elapsedMs, 0, durationMs);

  // use CEIL seconds to ensure the transition happens at 10s
  const seconds = Math.ceil(remain / 1000);
  const clockStr = fmtClockFromSeconds(seconds);

  if(!isBreak && item && item.subject){
    item.subject.studiedMs = clamp(baseStudiedAtStart + elapsedMs, 0, item.subject.plannedMs);
    renderPlan(); updateSummaries();
  }

  // 3) Use seconds to decide when to show "1 minute left" vs urgent last-10 behaviour
  if(seconds <= 60 && seconds > 10){
    // between 11s and 60s inclusive: show 1 minute left message
    display.innerHTML = `<span class="alert">1 minute left!</span> ${isBreak ? "Break" : "Studying"} ‚Äî ${clockStr}`;
    focusMsg.innerHTML = `<span class="alert">1 minute left!</span> ${isBreak ? "Break" : "Studying"} ‚Äî ${clockStr}`;
    // normal timer styling
    if(focusTimer){
      focusTimer.textContent = clockStr;
      focusTimer.classList.remove('urgent');
    }
  } else if(seconds <= 10){
    // urgent last 10 seconds (starts at 10)
    display.innerHTML = `${isBreak ? "Break" : "Studying"} ‚Äî <span class="warn">${clockStr}</span>`;
    focusMsg.innerHTML = `${isBreak ? "Break" : "Studying"} ‚Äî <span class="warn">${clockStr}</span>`;
    if(focusTimer){
      focusTimer.textContent = clockStr;
      focusTimer.classList.add('urgent');
    }
  } else {
    // more than 60 seconds remaining (or normal state)
    display.textContent = `${isBreak ? "Break" : "Studying"} ‚Äî ${clockStr} remaining`;
    focusMsg.textContent = `${isBreak ? "Break" : "Studying"} ‚Äî ${clockStr} remaining`;
    if(focusTimer){
      focusTimer.textContent = clockStr;
      focusTimer.classList.remove('urgent');
    }
  }

  if(elapsedMs >= durationMs){
    stopTimer(); alertSound.play();
    if(!isBreak){
      if(item && item.subject){
        item.subject.studiedMs = Math.min(item.subject.studiedMs, item.subject.plannedMs);
        saveSubjects(); renderPlan(); updateSummaries();
      }
      startBreak();
    } else {
      focusOverlay.style.display = 'none';
      display.textContent = 'üéâ Break complete!';
      display.classList.remove('timer-running');
      currentSubject = null;
      if(skipBreakBtn) skipBreakBtn.style.display='none';
      if(skipBreakFocusBtn) skipBreakFocusBtn.style.display='none';
      renderPlan();
    }
  }
}

function startBreak(){
  breakDurationMs = (parseInt(document.getElementById('breakMin').value,10) || 5) * 60000;
  startTime = Date.now(); lastTick = startTime; elapsedMs = 0; paused = false;
  durationMs = breakDurationMs; isBreak = true; currentSubject = null;

  focusHeading.textContent = "‚òï Break Time";
  focusSubject.textContent = "";
  focusMsg.textContent = "Take a breather ‚Äî relax for a bit!";
  focusOverlay.style.display = 'flex';

  if(skipBreakBtn) skipBreakBtn.style.display = 'inline-block';
  if(skipBreakFocusBtn) skipBreakFocusBtn.style.display = 'inline-block';

  display.classList.add('timer-running'); // show larger display also for break
  renderPlan();
  timerId = setInterval(()=>tick({}),200);
}

// ----- summaries -----
function updateSummaries(){
  const plannedDayMs = subjects.reduce((acc,s)=>acc + (s.plannedMs || 0), 0);
  const studiedDayMs = subjects.reduce((acc,s)=>acc + (s.studiedMs || 0), 0);
  const pctDay = plannedDayMs>0? Math.round((studiedDayMs/plannedDayMs)*100) : 0;
  dailySummary.textContent = `Today: Planned ${hrs(plannedDayMs)}h ‚Äî Studied ${hrs(studiedDayMs)}h (${pctDay}%)`;
  dailyBar.style.width = Math.min(100,pctDay) + '%';
  localStorage.setItem(getTodayKey(), studiedDayMs);

  let studiedWeekMs = 0;
  for(let i=0;i<7;i++){ const d=new Date(); d.setDate(d.getDate()-i); studiedWeekMs += parseInt(localStorage.getItem(getDateKey(d))||'0',10); }
  const weekTargetMs = (parseFloat(localStorage.getItem('weeklyGoalHours')) || weeklyGoalHours) * 3600000;
  const pctWeek = weekTargetMs>0 ? Math.round((studiedWeekMs/weekTargetMs)*100) : 0;
  weeklySummary.textContent = `Weekly Goal: ${ (localStorage.getItem('weeklyGoalHours') || weeklyGoalHours) }h ‚Äî Studied ${hrs(studiedWeekMs)}h (${pctWeek}%)`;
  weeklyBar.style.width = Math.min(100,pctWeek) + '%';
}

// ----- UI events -----
// Add subject
document.getElementById('addBtn').addEventListener('click', ()=>{
  const name = (subjectInput.value || '').trim();
  const planned = parseInt(document.getElementById('planned').value,10);
  if(!name){ alert('Enter subject'); return; }
  if(!planned || planned <= 0){ alert('Enter valid planned minutes'); return; }
  subjects.push({ name, plannedMs: planned * 60000, studiedMs: 0 });
  subjectInput.value = ''; document.getElementById('planned').value = '';
  saveSubjects(); normalizeSessionOrder(); renderPlan(); updateSummaries();
});

// START: uses startSelect to pick starting origIndex 
document.getElementById('startBtn').addEventListener('click', ()=>{
  if(subjects.length === 0){ alert('Add at least one subject'); return; }
  buildQueue();
  let startPos = -1;
  const val = startSelect.value;
  if(val !== ''){
    const origIndex = parseInt(val,10);
    startPos = queue.findIndex(q => q.origIndex === origIndex);
  }
  idx = (startPos >= 0) ? (startPos - 1) : -1;
  startNext();
  // ensure endedControls are hidden
  endedControls.style.display = 'none';
  mainControls.style.display = 'flex';
});

// Pause/resume
document.getElementById('pauseBtn').addEventListener('click', ()=>{
  paused = !paused; document.getElementById('pauseBtn').textContent = paused ? 'Resume' : 'Pause'; if(!paused) lastTick = Date.now();
});

// END SESSION: hide main controls, show Save / Start New 
document.getElementById('endBtn').addEventListener('click', ()=>{
  stopTimer(); alertSound.play();
  display.textContent = '‚èπÔ∏è Session ended.';
  display.classList.remove('timer-running');
  focusOverlay.style.display = 'none';
  isBreak = false; currentSubject = null;
  saveSubjects(); renderPlan(); updateSummaries();

  // hide main controls, show ended controls
  mainControls.style.display = 'none';
  endedControls.style.display = 'flex';
});

// SAVE SESSION: snapshot store (localStorage array)
saveSessionBtn.addEventListener('click', ()=>{
  const saved = JSON.parse(localStorage.getItem('savedSessions') || '[]');
  const snapshot = {
    at: (new Date()).toISOString(),
    subjects: JSON.parse(JSON.stringify(subjects)),
    totals: { plannedHours: subjects.reduce((a,s)=>a + ((s.plannedMs||0)),0), studiedHours: subjects.reduce((a,s)=>a + ((s.studiedMs||0)),0)}
  };
  saved.push(snapshot);
  localStorage.setItem('savedSessions', JSON.stringify(saved));
  // feedback
  display.textContent = '‚úÖ Session saved.';
  display.classList.remove('timer-running');
  // show main controls back so user can start new session if they want
  mainControls.style.display = 'flex';
  endedControls.style.display = 'none';
});

// START NEW SESSION (after ending)
startNewBtn.addEventListener('click', ()=>{
  // reset state indices (but keep subjects)
  stopTimer();
  idx = -1; timerId = null; isBreak = false; currentSubject = null; paused = false;
  display.textContent = 'No task running.';
  display.classList.remove('timer-running');
  focusOverlay.style.display = 'none';
  mainControls.style.display = 'flex';
  endedControls.style.display = 'none';
  renderPlan(); updateSummaries();
});

// RESET / Refresh Tracker: open in-app  
document.getElementById('resetBtn').addEventListener('click', ()=>{ confirmOverlay.style.display = 'flex'; });
confirmCancel.addEventListener('click', ()=>{ confirmOverlay.style.display = 'none'; });
confirmOk.addEventListener('click', ()=>{
  confirmOverlay.style.display = 'none';
  subjects = []; saveSubjects(); renderPlan();
  for(let i=0;i<7;i++){ const d=new Date(); d.setDate(d.getDate()-i); localStorage.removeItem(getDateKey(d)); }
  localStorage.removeItem('weeklyGoalHours'); localStorage.removeItem('sessionOrder');
  stopTimer(); display.textContent = 'No task running.'; display.classList.remove('timer-running'); focusOverlay.style.display = 'none';
  updateSummaries(); alert('Tracker cleared.');
});

// Focus overlay controls
document.getElementById('focusBtn').addEventListener('click', ()=>{ focusOverlay.style.display = 'flex'; });
document.getElementById('exitFocus').addEventListener('click', ()=>{ focusOverlay.style.display = 'none'; });
document.getElementById('pauseFocus').addEventListener('click', ()=>{ paused = !paused; document.getElementById('pauseBtn').textContent = paused ? 'Resume' : 'Pause'; if(!paused) lastTick = Date.now(); });

// Shared Skip Break handler 
function handleSkipBreak(){
  if(!isBreak) return;
  stopTimer();
  isBreak = false;
  if(skipBreakBtn) skipBreakBtn.style.display='none';
  if(skipBreakFocusBtn) skipBreakFocusBtn.style.display='none';
  if(idx + 1 < queue.length){ startNext(); }
  else { display.textContent = '‚èπÔ∏è Session ended.'; display.classList.remove('timer-running'); focusOverlay.style.display = 'none'; currentSubject = null; renderPlan(); updateSummaries(); }
}
skipBreakBtn.addEventListener('click', handleSkipBreak);
skipBreakFocusBtn.addEventListener('click', handleSkipBreak);

// dark mode
const darkModeBtn = document.getElementById('darkModeBtn');
const isDark = localStorage.getItem('darkMode') === 'true';
if(isDark){ document.body.classList.add('dark'); darkModeBtn.textContent = 'üåñ'; } else darkModeBtn.textContent = 'üåí';
darkModeBtn.addEventListener('click', ()=>{ document.body.classList.toggle('dark'); const active=document.body.classList.contains('dark'); localStorage.setItem('darkMode', active); darkModeBtn.textContent = active ? 'üåñ' : 'üåí'; });

// weekly goal save
document.getElementById('saveWeeklyBtn').addEventListener('click', ()=>{ const val = parseFloat(weeklyGoalInput.value); if(!val || val<=0){ alert('Enter a valid weekly hours goal'); return; } weeklyGoalHours = val; localStorage.setItem('weeklyGoalHours', weeklyGoalHours); updateSummaries(); alert('Weekly goal saved.'); });

// ----- initial setup -----
normalizeSessionOrder();
renderPlan();
updateSummaries();
setInterval(updateSummaries, 60000);

// populate initial suggestions
refreshRegisteredSubjects();

</script>
</body>
</html>




